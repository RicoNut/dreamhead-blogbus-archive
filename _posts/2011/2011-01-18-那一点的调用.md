---
layout: post
title: 那一点的调用
author: dreamhead
date: 2011-01-18 20:34:00 +0800
tags: [ '我眼看世界' ]
categories: [ '我眼看世界' ]
---

每每我讲如何写好代码，总会有人跳出来，无比惆怅的跟我说，你说的这些都挺好，我也认同，只是我面对的是一个有着悠久历史的遗留系统。然后，用一种痛说革命家史的架势，给我列举无数的理由。总而言之，一句话，不是我不想学好，形势让我没法学好。  
  
初时，我会耐心的听他叙述完一切，心中充满无比的同情。但是，让我百思不得其解的是，为啥我从来没遇到这种情况。我与人合作的过程中面对的难道不是同一个代码库吗？我怎么能坚持把代码写好，而且，奇怪的是，和我一起合作的人从来没有提出过这种问题。  
  
没有调查研究就没有发言权，我开始观察他们的工作方式，开始通过code diff了解他们修改代码的方式。当我看到在一大片代码被塞到了一个原本已经很大的函数里，我顿悟了，这就是差别。  
  
我知道旧代码非我一己之力一朝一夕可以改变，惹不起，躲得起。面对同样的情况，我会选择在一个新函数开始编写新代码，当然，作为ThoughtWorker，会有测试的。当我放心的完成了这个新函数，接下来，就是在旧代码里找到调用点，在那里放一个简单的函数调用。  
  
由于各种各样的原因，旧代码没有测试，甚至没办法测试，所以，新加的这个函数调用可能也测试不了，但是，只有一句没测试，显然比一大片代码没测试要令人更放心一些。  
  
这个思路简单得一塌糊涂。  
  
我做旧架构调整，用到的也是同样的思路，设计新架构，然后用一个dispatcher在入口处做分发，新旧架构得以并存。Martin Fowler的[DSL](http://martinfowler.com/dsl.html)里有一个Embedment Helper，也是类似的想法，如果需要在文法文件里嵌入代码，就是一句简单的函数调用，而把更多的代码放到另外的类里。  
  
从此以后，我不再同情那些抱怨沉重代码库让他们没法写好代码的人。


