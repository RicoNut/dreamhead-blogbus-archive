---
layout: post
title: 测试覆盖率，100%
author: dreamhead
date: 2011-05-11 22:42:00 +0800
tags: [ '开发笔记' ]
categories: [ '开发笔记' ]
---

测试覆盖率这东西，高了不代表有多好，但低了肯定是有问题。

在这个项目里，我们把测试覆盖率限制为100%，其结果是全部内容都会有测试覆盖。坚持这样的标准，在做重构的时候，可以比较放心。

**工具支持**  
我们用的测试覆盖率工具是cobertura，buildr缺省就对它进行有支持。  
&nbsp; require 'buildr/java/cobertura'

&nbsp; cobertura.check.branch\_rate = 100  
&nbsp; cobertura.check.line\_rate = 100  
&nbsp; （buildfile）

在命令行里运行如下命令就可以运行测试，进行检查，生成报告：  
&nbsp; buildr cobertura:html cobertura:check

如果覆盖率不达标，构建就会失败。这时，我们可以通过它生成的报告来看，到底是哪里没有覆盖。报告位于  
&nbsp; &nbsp; reports/cobertura/html/index.html

**提交流程**  
设定了目标，接下来，就是如何将这个目标贯彻下去。

为了确保大家在提交之前都会保证测试覆盖率，我们制作了一个提交脚本，其基本流程是：

- 检查更新
- 运行测试
- 提交代码

因为这个项目里用到都是一个分布式源码管理工具：git，所以，第一步我们做的是本地提交。

项目组代码提交都要通过这个脚本，以此保证我们提交的代码，测试覆盖率没有问题。一旦某人因为一些特殊原因，强行手工提交，我们还有CI进行保证，它同样会运行测试覆盖率检查，一旦失败，CI就会红掉。

**例外情况**  
真的是所有代码都会在这个100%的监控之下吗？不是。有一些代码只是为了调用一个特定的API，这样的代码是否100%意义不大，这样的测试本质上是在API写测试，而非自己的代码逻辑。所以，这种代码会被排除在外。  
&nbsp; cobertura.exclude /.\*.integration.\*/

但是，这样的代码同样会有相应的集成测试，只是不在单元测试的层面。一个基本的原则是，被排除的代码要尽可能少。在我们的项目里，只有这样只调用特定API的集成代码会被排除在外。

有了目标，有了工具支持，有了大家自我监督，100%其实也是一件很容易达到的事。


